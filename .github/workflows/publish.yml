# file: .github/workflows/publish.yml

name: 'Publish to Pub.dev & GitHub'

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

jobs:
  format-and-analyze:
    name: 'Format & Analyze'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: 'Install dependencies'
        run: flutter pub get

      - name: 'Format code'
        run: dart format .

      - name: 'Commit formatted code'
        id: commit_format
        continue-on-error: true
        # We generally don't want to push to main from a tag trigger, so specific release tag logic is better.
        # But to be safe, we will just analyze here. If code is not formatted, validate.yml should have caught it.
        run: echo "Skipping auto-commit on release tag."

      - name: 'Analyze project source'
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: 'Run tests'
        run: flutter test

      - name: 'Validate Publish (Dry Run)'
        run: flutter pub publish --dry-run

  publish:
    name: 'Publish to Pub.dev'
    needs: format-and-analyze
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # Required to retrieve the OIDC token from GitHub and configure pub.dev credentials
      - uses: dart-lang/setup-dart@v1

      - name: 'Publish to pub.dev'
        run: flutter pub publish --force